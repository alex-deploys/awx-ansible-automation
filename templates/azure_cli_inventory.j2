# Azure Dynamic Inventory - Generado con Azure CLI
# Fecha: {{ ansible_date_time.iso8601 }}
# Suscripción: {{ discovery_summary.subscription_name }}

{% if vms | length > 0 %}
# === VIRTUAL MACHINES POR RESOURCE GROUP ===
{% for rg in rgs %}
{% set rg_vms = vms | selectattr('resourceGroup', 'equalto', rg.name) | list %}
{% if rg_vms | length > 0 %}
[rg_{{ rg.name | regex_replace('[^a-zA-Z0-9]', '_') }}]
{% for vm in rg_vms %}
{% set vm_ip = vm_ips | selectattr('virtualMachine.name', 'equalto', vm.name) | map(attribute='virtualMachine.network.publicIpAddresses') | first | default([]) %}
{% set private_ip = vm_ips | selectattr('virtualMachine.name', 'equalto', vm.name) | map(attribute='virtualMachine.network.privateIpAddresses') | first | default([]) %}
{% set public_ip = vm_ip[0].ipAddress if vm_ip | length > 0 else 'no_public_ip' %}
{% set priv_ip = private_ip[0] if private_ip | length > 0 else 'no_private_ip' %}
{{ vm.name }} ansible_host={{ public_ip if public_ip != 'no_public_ip' else priv_ip }} azure_resource_group={{ vm.resourceGroup }} azure_location={{ vm.location }} azure_vm_size={{ vm.hardwareProfile.vmSize }} azure_os_type={{ vm.storageProfile.osDisk.osType }}
{% endfor %}

{% endif %}
{% endfor %}

# === AGRUPACIÓN POR UBICACIÓN ===
{% for location in vms | map(attribute='location') | unique %}
[location_{{ location | regex_replace('[^a-zA-Z0-9]', '_') }}]
{% for vm in vms %}
{% if vm.location == location %}
{{ vm.name }}
{% endif %}
{% endfor %}

{% endfor %}

# === AGRUPACIÓN POR TAMAÑO VM ===
{% for size in vms | map(attribute='hardwareProfile.vmSize') | unique %}
[size_{{ size | regex_replace('[^a-zA-Z0-9]', '_') }}]
{% for vm in vms %}
{% if vm.hardwareProfile.vmSize == size %}
{{ vm.name }}
{% endif %}
{% endfor %}

{% endfor %}

# === AGRUPACIÓN POR SISTEMA OPERATIVO ===
{% for os_type in vms | map(attribute='storageProfile.osDisk.osType') | unique %}
[os_{{ os_type | lower }}]
{% for vm in vms %}
{% if vm.storageProfile.osDisk.osType == os_type %}
{{ vm.name }}
{% endif %}
{% endfor %}

{% endfor %}

# === TODAS LAS VMs DE AZURE ===
[azure_vms:children]
{% for rg in rgs %}
{% set rg_vms = vms | selectattr('resourceGroup', 'equalto', rg.name) | list %}
{% if rg_vms | length > 0 %}
rg_{{ rg.name | regex_replace('[^a-zA-Z0-9]', '_') }}
{% endif %}
{% endfor %}

[azure_vms:vars]
ansible_user=azureuser
ansible_ssh_common_args=-o StrictHostKeyChecking=no
azure_managed=true
azure_discovery_method=azure_cli

{% else %}
# No se encontraron Virtual Machines en la suscripción
[azure_empty]
# Sin VMs disponibles

[azure_empty:vars]
azure_no_vms=true
{% endif %}