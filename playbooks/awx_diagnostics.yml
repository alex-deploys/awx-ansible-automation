---
- name: Diagnóstico de Entorno AWX
  hosts: localhost
  gather_facts: yes
  
  tasks:
    - name: Información del sistema
      debug:
        msg: |
          🔍 DIAGNÓSTICO DEL ENTORNO AWX
          
          🐍 Python: {{ ansible_python_version }}
          📁 Python Path: {{ ansible_python.executable }}
          💻 Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}
          🏷️  Hostname: {{ ansible_hostname }}
    
    - name: Verificar versión de Ansible
      command: ansible --version
      register: ansible_version
      changed_when: false
    
    - name: Mostrar versión de Ansible
      debug:
        msg: "{{ ansible_version.stdout_lines }}"
    
    - name: Listar colecciones instaladas
      command: ansible-galaxy collection list
      register: collections_list
      changed_when: false
      ignore_errors: yes
    
    - name: Mostrar colecciones
      debug:
        msg: "{{ collections_list.stdout_lines }}"
      when: collections_list is succeeded
    
    - name: Verificar módulos Python de Azure disponibles
      shell: |
        python3 -c "
        import sys
        modules = [
            'azure.common',
            'azure.mgmt.compute',
            'azure.mgmt.network', 
            'azure.mgmt.resource',
            'azure.mgmt.web',
            'azure.mgmt.storage',
            'azure.mgmt.sql',
            'azure.mgmt.rdbms',
            'azure.mgmt.postgresqlflexibleservers',
            'msrest',
            'msrestazure'
        ]
        for mod in modules:
            try:
                __import__(mod)
                print(f'✅ {mod}')
            except ImportError:
                print(f'❌ {mod} - NO DISPONIBLE')
        "
      register: python_modules
      changed_when: false
      ignore_errors: yes
    
    - name: Mostrar módulos Python
      debug:
        msg: "{{ python_modules.stdout_lines }}"
      when: python_modules is succeeded
    
    - name: Probar conexión a Azure (Resource Groups)
      azure.azcollection.azure_rm_resourcegroup_info:
      register: rg_test
      ignore_errors: yes
    
    - name: Resultado de prueba Azure
      debug:
        msg: |
          {% if rg_test is succeeded %}
          ✅ CONEXIÓN A AZURE: OK
          📁 Resource Groups encontrados: {{ rg_test.resourcegroups | length }}
          {% else %}
          ❌ CONEXIÓN A AZURE: ERROR
          Error: {{ rg_test.msg | default('Unknown error') }}
          {% endif %}
    
    - name: Probar módulo App Service Plans
      azure.azcollection.azure_rm_appserviceplan_info:
      register: asp_test
      ignore_errors: yes
    
    - name: Resultado App Service Plans
      debug:
        msg: |
          {% if asp_test is succeeded %}
          ✅ MÓDULO APP SERVICE PLANS: OK
          📱 App Service Plans encontrados: {{ asp_test.appserviceplans | length }}
          {% else %}
          ❌ MÓDULO APP SERVICE PLANS: ERROR
          Error: {{ asp_test.msg | default('Unknown error') }}
          {% endif %}
    
    - name: Variables de entorno relevantes
      debug:
        msg:
          - "AZURE_SUBSCRIPTION_ID: {{ lookup('env', 'AZURE_SUBSCRIPTION_ID') | default('No configurado') }}"
          - "AZURE_CLIENT_ID: {{ lookup('env', 'AZURE_CLIENT_ID') | default('No configurado') }}"
          - "AZURE_TENANT: {{ lookup('env', 'AZURE_TENANT') | default('No configurado') }}"
          - "AZURE_SECRET: {{ '***' if lookup('env', 'AZURE_SECRET') else 'No configurado' }}"
    
    - name: Resumen de diagnóstico
      debug:
        msg: |
          
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          📊 RESUMEN DEL DIAGNÓSTICO
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          
          ✅ Usar el playbook: azure_simple_inventory.yml
          
          Este playbook solo usa módulos básicos de Azure que
          están disponibles en la imagen de AWX execution environment.
          
          📝 Módulos que funcionan:
             - azure_rm_resourcegroup_info
             - azure_rm_appserviceplan_info
             - azure_rm_webapp_info (opcional)
             - azure_rm_storageaccount_info (opcional)
          
          ❌ Módulos que requieren SDKs adicionales:
             - azure_rm_sqlserver_info (requiere azure-mgmt-sql)
             - azure_rm_postgresql* (requiere azure-mgmt-rdbms)
             - azure_rm_mysql* (requiere azure-mgmt-rdbms)
          
          💡 Recomendación:
          Usa azure_simple_inventory.yml en lugar de
          azure_update_dynamic_inventory.yml para evitar
          problemas con dependencias faltantes.
