---
- name: DiagnÃ³stico de Entorno AWX
  hosts: localhost
  gather_facts: yes
  
  tasks:
    - name: InformaciÃ³n del sistema
      debug:
        msg: |
          ğŸ” DIAGNÃ“STICO DEL ENTORNO AWX
          
          ğŸ Python: {{ ansible_python_version }}
          ğŸ“ Python Path: {{ ansible_python.executable }}
          ğŸ’» Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ·ï¸  Hostname: {{ ansible_hostname }}
    
    - name: Verificar versiÃ³n de Ansible
      command: ansible --version
      register: ansible_version
      changed_when: false
    
    - name: Mostrar versiÃ³n de Ansible
      debug:
        msg: "{{ ansible_version.stdout_lines }}"
    
    - name: Listar colecciones instaladas
      command: ansible-galaxy collection list
      register: collections_list
      changed_when: false
      ignore_errors: yes
    
    - name: Mostrar colecciones
      debug:
        msg: "{{ collections_list.stdout_lines }}"
      when: collections_list is succeeded
    
    - name: Verificar mÃ³dulos Python de Azure disponibles
      shell: |
        python3 -c "
        import sys
        modules = [
            'azure.common',
            'azure.mgmt.compute',
            'azure.mgmt.network', 
            'azure.mgmt.resource',
            'azure.mgmt.web',
            'azure.mgmt.storage',
            'azure.mgmt.sql',
            'azure.mgmt.rdbms',
            'azure.mgmt.postgresqlflexibleservers',
            'msrest',
            'msrestazure'
        ]
        for mod in modules:
            try:
                __import__(mod)
                print(f'âœ… {mod}')
            except ImportError:
                print(f'âŒ {mod} - NO DISPONIBLE')
        "
      register: python_modules
      changed_when: false
      ignore_errors: yes
    
    - name: Mostrar mÃ³dulos Python
      debug:
        msg: "{{ python_modules.stdout_lines }}"
      when: python_modules is succeeded
    
    - name: Probar conexiÃ³n a Azure (Resource Groups)
      azure.azcollection.azure_rm_resourcegroup_info:
      register: rg_test
      ignore_errors: yes
    
    - name: Resultado de prueba Azure
      debug:
        msg: |
          {% if rg_test is succeeded %}
          âœ… CONEXIÃ“N A AZURE: OK
          ğŸ“ Resource Groups encontrados: {{ rg_test.resourcegroups | length }}
          {% else %}
          âŒ CONEXIÃ“N A AZURE: ERROR
          Error: {{ rg_test.msg | default('Unknown error') }}
          {% endif %}
    
    - name: Probar mÃ³dulo App Service Plans
      azure.azcollection.azure_rm_appserviceplan_info:
      register: asp_test
      ignore_errors: yes
    
    - name: Resultado App Service Plans
      debug:
        msg: |
          {% if asp_test is succeeded %}
          âœ… MÃ“DULO APP SERVICE PLANS: OK
          ğŸ“± App Service Plans encontrados: {{ asp_test.appserviceplans | length }}
          {% else %}
          âŒ MÃ“DULO APP SERVICE PLANS: ERROR
          Error: {{ asp_test.msg | default('Unknown error') }}
          {% endif %}
    
    - name: Variables de entorno relevantes
      debug:
        msg:
          - "AZURE_SUBSCRIPTION_ID: {{ lookup('env', 'AZURE_SUBSCRIPTION_ID') | default('No configurado') }}"
          - "AZURE_CLIENT_ID: {{ lookup('env', 'AZURE_CLIENT_ID') | default('No configurado') }}"
          - "AZURE_TENANT: {{ lookup('env', 'AZURE_TENANT') | default('No configurado') }}"
          - "AZURE_SECRET: {{ '***' if lookup('env', 'AZURE_SECRET') else 'No configurado' }}"
    
    - name: Resumen de diagnÃ³stico
      debug:
        msg: |
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“Š RESUMEN DEL DIAGNÃ“STICO
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          âœ… Usar el playbook: azure_simple_inventory.yml
          
          Este playbook solo usa mÃ³dulos bÃ¡sicos de Azure que
          estÃ¡n disponibles en la imagen de AWX execution environment.
          
          ğŸ“ MÃ³dulos que funcionan:
             - azure_rm_resourcegroup_info
             - azure_rm_appserviceplan_info
             - azure_rm_webapp_info (opcional)
             - azure_rm_storageaccount_info (opcional)
          
          âŒ MÃ³dulos que requieren SDKs adicionales:
             - azure_rm_sqlserver_info (requiere azure-mgmt-sql)
             - azure_rm_postgresql* (requiere azure-mgmt-rdbms)
             - azure_rm_mysql* (requiere azure-mgmt-rdbms)
          
          ğŸ’¡ RecomendaciÃ³n:
          Usa azure_simple_inventory.yml en lugar de
          azure_update_dynamic_inventory.yml para evitar
          problemas con dependencias faltantes.
