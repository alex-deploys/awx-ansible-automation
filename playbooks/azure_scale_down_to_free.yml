---
- name: Reducir App Service Plans a Free (F1) - Manual
  hosts: localhost
  gather_facts: no
  vars:
    target_tier: "Free"
    target_size: "F1"
  
  tasks:
    - name: Obtener App Service Plans actuales
      azure.azcollection.azure_rm_appserviceplan_info:
      register: service_plans
    
    - name: Identificar planes en tier Basic
      set_fact:
        basic_plans: "{{ service_plans.appserviceplans | selectattr('sku.tier', 'equalto', 'Basic') | list }}"
    
    - name: Mostrar planes a reducir
      debug:
        msg: |
          🔽 REDUCIR A FREE (F1)
          
          Planes encontrados en tier Basic: {{ basic_plans | length }}
          {% for sp in basic_plans %}
          - {{ sp.name }} ({{ sp.resource_group }})
          {% endfor %}
          
          💰 Ahorro estimado: ~${{ basic_plans | length * 13 }}/mes
    
    - name: Reducir a Free F1
      azure.azcollection.azure_rm_appserviceplan:
        resource_group: "{{ item.resource_group }}"
        name: "{{ item.name }}"
        location: "{{ item.location }}"
        sku:
          name: "{{ target_size }}"
          tier: "{{ target_tier }}"
          capacity: 1
      loop: "{{ basic_plans }}"
      loop_control:
        label: "{{ item.name }}"
      when: basic_plans | length > 0
    
    - name: Resultado
      debug:
        msg: |
          {% if basic_plans | length > 0 %}
          ✅ {{ basic_plans | length }} Service Plan(s) reducido(s) a {{ target_tier }} ({{ target_size }})
          💰 Ahorro mensual: ~${{ basic_plans | length * 13 }}
          {% else %}
          ℹ️  No se encontraron Service Plans en tier Basic
          {% endif %}